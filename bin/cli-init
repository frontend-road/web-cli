#!/usr/bin/env node

const path = require('path')
const program = require('commander')
const chalk = require('chalk')
const semver = require('semver')
const inquirer = require('inquirer')
const ora = require('ora')
const package = require('../package.json')

program
  .version(package.version)
  // .option('-d, --debug', 'output extra debugging')
  // .option('-s, --small', 'small pizza size')
  // .option('-p, --pizza-type <type>', 'flavour of pizza')
  // .command('init', 'create a vue project')
  // .command('build', 'build a project')

program.on('--help', () => {
  console.log()
  console.log(chalk.blue('  ç”¨æ¨¡æ¿åˆ›å»ºä¸€ä¸ªé¡¹ç›®'))
  console.log(' $ cli init webpack-simple test')
  console.log()
})

function checkNodeVersion(wanted, id) {
  if (!semver.satisfies(process.version, wanted)) {
    console.log(chalk.cyan(`å½“å‰ Node.js ç‰ˆæœ¬æ˜¯ ${process.version}ï¼Œä½†æ˜¯æ­¤é¡¹ç›® ${id} éœ€è¦çš„ç‰ˆæœ¬ä¸º ${wanted}`))
    process.exit(1)
  }
}
checkNodeVersion(package.engines.node, 'cli')

program.parse(process.argv)

// console.log(process.argv)
// console.log(program.args)

function help() {
  program.parse(process.argv)
  console.log('program.args:', program.args)
  if (program.args.length < 1) {
    return program.help()
  }
}
help()

// cli init webpack test
// cli init webpack .
// cli init webpack
const template = program.args[0]
const rawName = program.args[1]
console.log('template:', template)
console.log('rawName:', rawName)
const inPlace = !rawName || rawName === '.' || rawName === './'
console.log('æ˜¯å¦å½“å‰ç›®å½•ï¼š', inPlace)
const name = inPlace ? path.resolve('../', process.cwd()) : rawName
console.log('dirname:', name)

inquirer.prompt([
  {
    type: 'confirm',
    name: 'confirm-test',
    message: inPlace ? 'åœ¨å½“å‰ç›®å½•åˆ›å»º' : `æ–°åˆ›å»ºä¸€ä¸ªç›®å½•${rawName}ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ`
  },
  {
    type: 'input',
    name: 'input-test'
  },
  {
    type: 'checkbox',
    name: 'checkbox-test',
    choices: ['Choice A', 'Choice B', new inquirer.Separator(), 'Choice C', 'Choice D']
  },
  {
    type: 'password',
    name: 'password-test'
  }
]).then(answers => {
  console.log(answers)
  if (answers['confirm-test']) {
    // copy
    console.log(chalk.green(`starting copy ${template}`))
    copy()
  } else {
    console.log(chalk.red('oops'))
  }
})

function copy() {
  const spinner = ora({
    text: `Loading ${chalk.red('unicorns')}`,
    prefixText: 'ğŸ‡¨ğŸ‡³',
    spinner: 'dots',
    color: 'white',
  }).start()
  setTimeout(() => {
    spinner.color = 'green'
    spinner.text = 'Loading rainbows'
  }, 3000)
  setTimeout(() => {
    spinner.stop()
  }, 6000)
}
